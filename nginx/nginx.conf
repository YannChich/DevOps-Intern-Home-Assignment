worker_processes auto;

events {
    worker_connections 1024;
}

http {
    # Include default MIME types for proper Content-Type handling
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout  65;

    # Rate limiting configuration:
    # Define a shared memory zone "perip" that tracks requests per client IP.
    # Limit rate to 5 requests per second.
    limit_req_zone $binary_remote_addr zone=perip:10m rate=5r/s;

    # When a request is rejected due to rate limiting, return HTTP 429.
    limit_req_status 429;

    # Server 1: HTTP success server on port 8080 with rate limiting
    server {
        listen 8080;
        server_name localhost;

        # For this server we want to return HTML content
        default_type text/html;

        location / {
            # Apply rate limiting using the "perip" zone.
            limit_req zone=perip burst=1 nodelay; 

            # Return a 200 OK with a simple custom HTML response
            return 200 '<html><body><h1>Welcome from Nginx on port 8080</h1><p>This is the success server.</p></body></html>';
        }
    }

    # Server 2: HTTP error server on port 8081 (no rate limiting required here)
    server {
        listen 8081;
        server_name localhost;

        location / {
            # Always return a 500 Internal Server Error for any request
            return 500;
        }
    }

    # Server 3: HTTPS success server on port 8443 with rate limiting
    server {
        listen 8443 ssl;
        server_name localhost;

        # Use the self-signed certificate generated in the Dockerfile
        ssl_certificate     /etc/nginx/ssl/selfsigned.crt;
        ssl_certificate_key /etc/nginx/ssl/selfsigned.key;

        default_type text/html;

        location / {
            # Apply the same rate limiting on HTTPS as on HTTP
            limit_req zone=perip burst=1 nodelay;

            return 200 '<html><body><h1>Welcome from Nginx over HTTPS (8443)</h1><p>This is the HTTPS success server.</p></body></html>';
        }
    }
}

